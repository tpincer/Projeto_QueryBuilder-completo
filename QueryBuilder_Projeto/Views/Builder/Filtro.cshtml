@{
    ViewBag.Title = "Filtro";
}

    <div class="row">
        <div class="container bs-docs-container">

            <section class="bs-docs-section clearfix">
                <span> Consulta </span>

                <div class="row">
                    <div class="col-md-12">
                        <div id="builder-import_export" class="query-builder form-inline"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="btn-group">
                            <button class="btn btn-warning reset" data-target="import_export">Resetar</button>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-primary parse-sql" data-target="import_export" data-stmt="false">Filtrar</button>
                        </div>
                    </div>
                </div>
            </section>
            <div class="row espaco">
                <div class="col-md-12">
                    <div id="container-table">
                        @Html.Raw(ViewBag.Tabelas)
                    </div>
                </div>
            </div>

            <style>
                .code-popup {
                    max-height: 500px;
                }

                .espaco {
                    margin-top: 20px;
                }
            </style>

        </div>
    </div>

@section scripts
{
<script src="~/Scripts/js/bootbox.min.js"></script>

<link href="~/Content/styles/query-builder.default.min.css" rel="stylesheet">

<script src="~/Scripts/js/query-builder.standalone.min.js"></script>
<script src="~/Scripts/js/sql-parser.min.js"></script>

<script>var baseurl = 'https://querybuilder.js.org';</script>
<script src="~/Scripts/js/demo-import-export.js"></script>
<!-- aqui a magica acontece -->
<script src="~/Scripts/js/demo.js"></script>

<script>

    $('#builder-import_export').queryBuilder({
        plugins: [
            'bt-tooltip-errors',
            'not-group'
        ],

        filters: @Html.Raw(ViewBag.DefinicaoFiltros),

        lang_code: "pt-BR"
    });


    $('.parse-sql').on('click', function () {
        var target = $(this).data('target');
        var result = $('#builder-' + target).queryBuilder('getSQL', $(this).data('stmt'));

        if (result.sql.length) {

            var arrays = "@Request["Colunas"]"

            var settings = {
                "url": "@Url.Content("~/Builder/Renderize")",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "tabela": "@Html.Raw(ViewBag.Tab)",
                    "campos": "@Html.Raw(ViewBag.Cols)",
                    "Content-Type": "text/plain"
                },
                "data": result.sql,
            };

            $.ajax(settings).done(function (response) {
                populateTable(response)
                console.log(response);
                console.log(result.sql);
            });
        }
    });

    $('.reset').on('click', function () {
        var ele = $('#container-table');
        ele.empty();
    })

    populateTable = function (data) {
        var ele = $('#container-table');
        ele.empty();
        ele.html(data);
    }

</script>
}